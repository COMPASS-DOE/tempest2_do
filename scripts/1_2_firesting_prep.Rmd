---
title: "Firesting Prep"
author: "PR"
date: "2024-03-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, 
                      message = F, 
                      warning = F)
```

### General purpose

I'm creating Rmds for each of the datastreams used in this project. Because our deployments were a little complex, and both SWAP and Firesting datasets were somewhat cobbled together, it's important to document as many details as possible as clearly as possible in order to streamline QC, clearly ID and explain any data decisions, and make the methods section easy to write.

### Firesting deployment

We deployed a total of 11 Firesting sensors across the plots for TEMPEST 2 (June 2023). Both treatment plots (freshwater and estuarine) were outfitted with 4-channel Firesting loggers, each with 4 DO sensors and one temperature sensor, with sensors deployed 5/10/20/30 cm below the ground surface. Due to a limited number of sensors, we deployed three DO sensors in the control plot, each connected to a Firesting handheld, at 10, 20, and 30 cm. All times were synchronized to EST (GMT - 5) because we learned all about the pain of different time-zones during TEMPEST 1, and all sensors were calibrated at the same time and in the same place (i.e., all sensors were bundled together and allowed to equilibrate for several minutes) in the GCREW lab immediately prior to deployment. 

```{r Setup}
## First, load setup script to set up environment
source("../scripts/0_0_setup.R")

## Firesting general paths
four_channel_path <- "../data/raw_data/firesting/four_channel/"
handheld_path <- "../data/raw_data/firesting/handheld/"

## Set FW paths
fw1_filepath <- paste0(four_channel_path, "2023-06-04_082732_230604_fw_tempest_1/ChannelData")
fw2_filepath <- paste0(four_channel_path, "2023-06-05_100032_230605_fw_tempest_2/ChannelData")
fw3_filepath <- paste0(four_channel_path, "2023-06-08_081002_230605_fw_tempest_3/ChannelData")
fw4_filepath <- paste0(four_channel_path, "2023-06-09_153100_230605_fw_tempest_4/ChannelData")
fw5_filepath <- paste0(four_channel_path, "2023-06-09_153100_230605_fw_tempest_5/ChannelData")

## Set SW paths
sw1_filepath <- paste0(four_channel_path, "2023-06-04_084853_230604_sw_tempest_1/ChannelData")
sw2_filepath <- paste0(four_channel_path, "2023-06-08_081743_230607_tempest_sw_2/ChannelData")
sw3_filepath <- paste0(four_channel_path, "2023-06-09_152744_230607_tempest_sw_3/ChannelData")
```


```{r Read in 4-channel data}

## Set raw firesting data column names
four_channel_names <- c("date", "time", "dt_s", "do_percent_sat", "dphi", 
                     "intensity_mv", "light_mv", "do_status", "temp_date", "temp_time", 
                     "temp_dt_s", "temp_c", "temp_status", "press_date", "press_time", 
                     "press_dt_s", "pressure_mbar", "press_status")

import_4channel <- function(path){
  
  import_firesting <- function(filepath) {
    ## Read in the 4 O2 channels and temperature
    read_delim(filepath, delim = "\t", skip = 25,  col_names = F) %>% 
      magrittr::set_colnames(four_channel_names) %>% 
      mutate(datetime_raw = paste(date, time)) %>% 
      mutate(datetime = lubridate::as_datetime(datetime_raw, format = "%d-%m-%Y %H:%M:%S", 
                                                   tz = common_tz)) %>% 
      dplyr::select(datetime_raw, datetime, temp_c, do_percent_sat)
  }
  
  firsting1 <- import_firesting(file.path(path, "A_Firesting O2 (4 Channels)_(A Ch.1)_Oxygen.txt")) %>%
    mutate(depth = 5)
  firsting2 <- import_firesting(file.path(path, "A_Firesting O2 (4 Channels)_(A Ch.2)_Oxygen.txt")) %>% 
    mutate(depth = 10)
  firsting3 <- import_firesting(file.path(path, "A_Firesting O2 (4 Channels)_(A Ch.3)_Oxygen.txt")) %>% 
    mutate(depth = 20)
  firsting4 <- import_firesting(file.path(path, "A_Firesting O2 (4 Channels)_(A Ch.4)_Oxygen.txt")) %>% 
    mutate(depth = 30)
  
  bind_rows(firsting1, firsting2, firsting3, firsting4)
}

fw <- bind_rows(import_4channel(fw1_filepath), 
                import_4channel(fw2_filepath), 
                import_4channel(fw3_filepath), 
                import_4channel(fw4_filepath), 
                import_4channel(fw5_filepath)) %>% 
  mutate(datetime = round_date(datetime, "5 min")) %>% 
  mutate(plot = "FW")

sw <- bind_rows(import_4channel(sw1_filepath), 
                import_4channel(sw2_filepath), 
                import_4channel(sw3_filepath)) %>% 
  mutate(datetime = round_date(datetime, "5 min")) %>% 
  mutate(plot = "SW")

fwsw_data <- bind_rows(fw, sw)

```

```{r read in control data}
# 3. Read in handheld data -----------------------------------------------------

## Make filepaths for each depth
handheld_path_10cm <- paste0(handheld_path, "le_10cm")
handheld_path_20cm <- paste0(handheld_path, "mcrl_20cm")
handheld_path_30cm <- paste0(handheld_path, "serc_30cm")

read_handheld <- function(path, sensor_depth){
 
  files <- list.files(path, full.names = T)

  read_file <- function(...){
    
    ## Save column headers as a row in a tibble
    handheld_colnames <- read_delim(..., delim = "\t", skip = 15, col_names = F) %>% 
      slice(1) %>% 
      unlist(., use.names=FALSE) %>% 
      str_remove_all(., "[^[:alnum:]]")
    
    read_delim(..., delim = "\t", skip = 16,  col_names = F) %>% 
      magrittr::set_colnames(handheld_colnames) %>% 
      clean_names() %>% 
      rename("do_percent_sat" = oxygenairsat, 
             "temp_c" = temperature_c) %>% 
      mutate(datetime_raw = parse_date(date_time_yyyymmd_dhhmmss)) %>% 
      mutate(datetime = round_date(lubridate::as_datetime(datetime_raw, tz = common_tz), "5 min")) %>% 
      select(datetime_raw, datetime, temp_c, do_percent_sat) %>% 
      mutate(datetime_raw = as.character(datetime_raw))
  }
  
  files %>% 
    map(read_file) %>% 
    bind_rows() %>% 
    dplyr::arrange(datetime) %>% 
    filter(datetime > "2023-06-01") %>% 
    mutate(depth = sensor_depth,
           plot = "Control")
}

control_data <- bind_rows(read_handheld(handheld_path_10cm, 10), 
                          read_handheld(handheld_path_20cm, 20), 
                          read_handheld(handheld_path_30cm, 30))
```

### Initial plots {.tabset}

#### 4-channels

```{r plot 4-channel}
fwsw_data %>% 
  filter(datetime >= event_start & 
           datetime <= event_end) %>% 
  ggplot(aes(datetime, do_percent_sat, color = as.factor(depth))) + 
  geom_line() + 
  facet_wrap(~plot, ncol = 1) + 
  labs(x = "DO (%)", color = "Depth (cm)")
```


#### handhelds

```{r plot control}
control_data %>% 
  filter(datetime >= event_start & 
           datetime <= event_end) %>% 
  ggplot(aes(datetime, do_percent_sat, color = as.factor(depth))) + 
  geom_line() + 
  labs(x = "DO (%)", color = "Depth (cm)")
```

### QC

Because the firestings weren't really touched, and because all sensors behaved, we actually don't have any QC decisions to document, because we didn't do any QC...


```{r merge datsets}
df <- bind_rows(fwsw_data, control_data) %>% 
  filter(datetime >= event_start & datetime <= event_end) %>% 
  mutate(do_percent_sat = ifelse(do_percent_sat < 0, 0, do_percent_sat)) %>% 
  mutate(plot = case_when(plot == "FW" ~ "Freshwater", 
                          plot == "SW" ~ "Estuarine", 
                          TRUE ~ plot)) %>% 
  mutate(datetime_est = as.character(datetime))

```

```{r write out final dataset}
write_csv(df, "../data/240318_firesting_data_final.csv")
```



