---
title: "231101_teros_rework"
output: html_document
date: "2023-11-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, 
                      warning = F,
                      message = F)
```

### Purpose

Althought the TEROS data was worked up already in 230710_clean_teros, the resulting dataset still doesn't seem right. I'm going to take the datasets cleaned of obvious errors, but before any merging / binning occurs to see what makes sense to use, and how to process them.


### The problem

Based on the script referenced, here are the "final" datasets for TEROS, which clearly show jumpy behavior indicative of inappropriate binning.

```{r}

require(pacman)

p_load(tidyverse, 
       cowplot)

old_data <- read_csv("../data/230610_teros_medians.csv")

old_data %>% 
  ggplot(aes(datetime, vwc)) + 
  geom_line() + 
  facet_wrap(plot~depth)
```
We'll start with the raw datasets, and go from there. Let's start by looking at Control at 30cm since we know what that pattern should be, and there are two clear issues to diagnose: the step change, and the spikes

```{r load raw datasets}
raw_5min <- read_csv("../data/231101_teros_5min_raw.csv")
raw_15min <- read_csv("../data/231101_teros_15min_raw.csv")

raw_vwc_plot <- function(data){
  
  data %>% 
    filter(plot == "Control" & depth == 30) %>% 
    ggplot(aes(datetime, vwc)) + 
    geom_line() + 
    facet_wrap(~grid_square)
}

plot_grid(raw_vwc_plot(raw_5min) + ggtitle("5-minute"), 
          raw_vwc_plot(raw_15min) + ggtitle("15-minute"))
```
If we combine the 15-minute data as means and medians, does that fix things? Nope. What the fuck is going on.

```{r}
raw_15min %>% 
  filter(plot == "Control" & depth == 30) %>% 
  group_by(datetime) %>% 
  summarize(mean_vwc = mean(vwc, na.rm = T), 
            median_vwc = median(vwc, na.rm = T)) %>% 
  ggplot(aes(datetime)) + 
  geom_line(aes(y = mean_vwc), color = "red") + 
  geom_line(aes(y = median_vwc), color = "blue") + 
  ggtitle("Red: mean, Blue: median")
```




