---
title: "231204_redox_corrections"
output: html_document
date: "2023-12-04"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F,
                      message = F,
                      warning = F)
```

### Goal

Detail the steps used to go from raw redox values collected by SWAP sensors during TEMPEST to final Eh values to be used on poster / in paper.

```{r Set up dataset}
# 1. Setup ---------------------------------------------------------------------

source("../scripts/0_0_setup.R")

## Load packages
require(pacman)
p_load(tidyverse, 
       rdrop2, 
       cowplot, 
       rstatix,
       lubridate, 
       plotly,
       parsedate, # parse_date()
       janitor, # clean_names()
       purrr) # map()

## Set ggplot theme
theme_set(theme_bw())


# 2. Pull in data and format ---------------------------------------------------

## Control is PB81, logger is labeled CR1000
## FW is PB82, logger is labeled CR1000_2
## SW is PB83, logger is labeled CR1000_3

read_swap <- function(path){
  read_delim(path, skip = 1) %>% 
    slice(3:n()) %>% 
    mutate(across(c(contains("Batt"), contains("Redox")), as.numeric)) %>% 
    clean_names() %>% 
    mutate(datetime = lubridate::as_datetime(timestamp, tz = common_tz)) 
}


swap_list <- list.files(path = "../data/swap", pattern = ".dat", full.names = "T")

control <- read_swap(swap_list[grepl("81", swap_list)]) %>% 
  mutate(plot = "Control")
fw <- read_swap("../data/swap/CR1000_2_Table1.dat") %>% 
  mutate(plot = "FW")
sw <- read_swap(swap_list[grepl("83", swap_list)]) %>% 
  mutate(plot = "SW")

set_depths <- function(data){
  data %>% 
    pivot_longer(cols = contains("redox_"), names_to = "sensor", values_to = "redox_mv") %>% 
    separate(sensor, into = c("scrap", "ref", "sensor"), sep = "_") %>% 
    mutate(depth_cm = case_when(sensor == "1" | sensor == "5" | sensor == "9" | sensor == "13" | sensor == "17" ~ 5, 
                             sensor == "2" | sensor == "6" | sensor == "10" | sensor == "14" | sensor == "18" ~ 15, 
                             sensor == "3" | sensor == "7" | sensor == "11" | sensor == "15" | sensor == "19" ~ 30, 
                             sensor == "4" | sensor == "8" | sensor == "12" | sensor == "16" | sensor == "20" ~ 50,
                             TRUE ~ 0)) %>% 
    select(-c(statname, scrap, timestamp))
}

df_raw <- bind_rows(set_depths(control), 
                set_depths(fw), 
                set_depths(sw)) %>% 
  filter(datetime >= pre_event_start & 
           datetime <= post_event_end) 

# Because FW record starts before Control/SW, trim to match
sw_start <- min(df_raw %>% filter(plot == "SW") %>% pull(datetime))

df_trimmed <- df_raw %>% 
  filter(datetime >= sw_start)

```


### Raw data {.tabset}

I know it gets old looking at time-series, but I'd like to present ALL the data in completely raw format first, so that we're all starting at 0. Note the dashed vertical line below marks the start of the last sensors we got online (seawater plot) so that we're starting a consistent datetime origin across plots:


#### Freshwater

Behavior looks very similar between reference probes (ra and rb). 
```{r}

df_raw %>% 
  filter(plot == "FW") %>% 
  ggplot(aes(datetime, redox_mv, color = as.factor(depth_cm), group = sensor)) + 
  geom_line() + 
  geom_vline(xintercept = sw_start, linetype = "dashed") + 
  facet_wrap(~ref) + 
  ggtitle("Raw redox - Freshwater")

```

#### Estuarine

As with Freshwater, we see similar behavior between reference probes.
```{r}

df_raw %>% 
  filter(plot == "SW") %>% 
  ggplot(aes(datetime, redox_mv, color = as.factor(depth_cm), group = sensor)) + 
  geom_line() + 
  geom_vline(xintercept = sw_start, linetype = "dashed") + 
  facet_wrap(~ref) + 
  ggtitle("Raw redox - Estuarine")

```

#### Control

And this is where things get funky. Based on behavior in the other two plots, and particularly at depth, we don't see clear diurnal signals in the data. While Control might be more susceptible due to thinner canopy, I'm hard-pressed to believe that daily cycles of 200 mV is real, and happening consistently at all depths.


```{r}

df_raw %>% 
  filter(plot == "Control") %>% 
  ggplot(aes(datetime, redox_mv, color = as.factor(depth_cm), group = sensor)) + 
  geom_line() + 
  geom_vline(xintercept = sw_start, linetype = "dashed") + 
  facet_wrap(~ref) + 
  ggtitle("Raw redox - Control")

```

###

**Decision: Use "ra" as reference**


### Binning {.tabset}

First, let's average across the 5 sensors at each depth-plot combo and plot as boxplots for reference. We've got some issues of zeros that are clearly erroneous. Super fortunately, they only occur in Control and Seawater, neither of which have sensors that realistically reach zero (and no values are exactly 0 in Freshwater), so we will scrub 0s then interpolate to gap-fill a total of 16 values (4 timestamp/plot combos x 4 depths).

**Decision: Include all sensors, use means, and scrub then gap-fill 0s**

#### Binned but with errors

```{r}

## We're also filtering to just the first ref probe based on early issues with rb
df_binned <- df_trimmed %>% 
  group_by(datetime, depth_cm, ref, plot) %>% 
  summarize(batt_v = mean(batt_v), 
            redox_mv = mean(redox_mv)) %>% 
  filter(ref == "ra") %>% 
  mutate(datetime_raw = as.character(datetime)) %>% 
  mutate(plot = case_when(plot == "FW" ~ "Freshwater", 
                          plot == "SW" ~ "Seawater", 
                          TRUE ~ plot)) 

ggplot(df_binned, aes(datetime, redox_mv, color = as.factor(depth_cm))) + 
  geom_line() + 
  facet_wrap(~plot, ncol = 1)
```

#### Binned with errors gap-filled

```{r}

df_gapfilled <- df_binned %>% 
  ungroup() %>% 
  group_by(depth_cm, plot) %>% 
  mutate(redox_mv = ifelse(redox_mv == 0, NA, redox_mv)) %>% 
  tidyr::fill(redox_mv, .direction = "updown")

ggplot(df_gapfilled, aes(datetime, redox_mv, color = as.factor(depth_cm))) + 
  geom_line() + 
  facet_wrap(~plot, ncol = 1)
```


### Corrections

Based on my nascent understanding of redox, there are several potential corrections, including
 
  * changes in temperature
  * soil pH
  * conversion to Eh units
 
 
I'll do the correction for temperature at the same time as the conversion to SHE using $Eh=ORP-0.718*T+224.41$. This equation was pulled from [Fausto's pre-print](https://www.biorxiv.org/content/10.1101/2023.06.12.544684v1.full.pdf) (see L154) which he applied to both soil and water redox sensors. 

**Decision: use Fausto's correction equation for final units**

```{r}
join_cols = c("datetime", "plot", "depth_cm")

teros <- read_csv("../data/231102_teros_final.csv") %>%  
  mutate(datetime = force_tz(datetime, tzone = common_tz)) %>% 
  rename("depth_cm" = depth) %>% 
  select(all_of(join_cols), tsoil) %>%
  group_by(datetime, plot) %>% 
  complete(depth_cm = c(5, 15, 30, 50), fill = list(tsoil = NA)) %>% 
  fill(tsoil, .direction = "down")


df_cor <- df_gapfilled %>% 
  left_join(teros, by = c(join_cols)) %>% 
  mutate(eh_mv = redox_mv - (tsoil * .718) + 224.41)
  
p_redox <- ggplot(df_cor, aes(plot, redox_mv)) + 
  geom_boxplot() + 
  geom_hline(yintercept = 0) + 
  geom_hline(yintercept = 1000) + 
  ggtitle("Raw redox (mv)")

p_eh <- ggplot(df_cor, aes(plot, eh_mv)) + 
  geom_boxplot() + 
    geom_hline(yintercept = 0) + 
  geom_hline(yintercept = 1000) + 
  ggtitle("Eh (mv)")

plot_grid(p_redox, p_eh, nrow = 1)
```

### Questions for y'all

1. What corrections am I missing that need to be incorporated? 
2. Does the equation used to correct make sense? 
3. Smell test: what feels wrong and what feels right?

