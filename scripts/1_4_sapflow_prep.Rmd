---
title: "Sapflow data prep"
author: "PR"
date: "2024-04-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, 
                      message = F,
                      warning = F)
```

### General purpose

I'm creating Rmds for each of the datastreams used in this project. Because our deployments were a little complex, and both SWAP and Firesting datasets were somewhat cobbled together, it's important to document as many details as possible as clearly as possible in order to streamline QC, clearly ID and explain any data decisions, and make the methods section easy to write.

### Sapflow deployment

Sapflow sensors were deployed well prior to any flooding in three species of trees across TEMPEST plots. I honestly don't know much about their deployment, which is okay because these data, in contrast to TEROS/Firesting/SWAP datasets is being pulled in as L1 curated data from GDrive meaning initial QC has already taken place (no need to edit timestamps, etc).

```{r Setup}
## First, load setup script to set up environment
source("../scripts/0_0_setup.R")

p_load(tictoc)
```

```{r Create file list}
raw_data_path <- "../data/l1_raw_files/"

options(gargle_oauth_email = "peter.regier@pnnl.gov")

## .../Sensor Data Releases/Level1/v1-0/TMP_2023
l1_file_list <- drive_ls("https://drive.google.com/drive/folders/1-ebNwEWViTIo2fb6fmPryfXJmD_VmHsK",
                     pattern = ".csv")

dates_to_include = c("20230501", "20230601", "20230701", "20230801")

l1_file_list_filtered <- l1_file_list %>% 
  filter(str_detect(name, str_c(dates_to_include, collapse = "|")))

## Obsolete hyperlink??? broken as of 5/7/24
#l1_file_list <- drive_ls("https://drive.google.com/drive/folders/1HNsS2ACiZ_efOPJGtGzr5IxGBjBcsOPb", 
#                      pattern = ".csv")
```

```{r Pull L1 data from Gdrive, eval = F}
## I'm keeping this chunk just for perpetuity, but it's not used since I've already
## pulled down the data I want, and it takes a while to run since the files are big

drive_download_ <- function(data){
  #message(paste("Downloading", data$name))
  # you could add an ifelse to only download files it doesn't fine in raw_data_path
  drive_download(data$id, overwrite = T, path = paste0(raw_data_path, data$name))
}

## Use a for-loop to read in files in a way that I can see what's going on
## Download data to local. I tried to map() but for some reasons it doesn't work?
tic("pull data from gdrive") #48s
for(i in 1:nrow(l1_file_list_filtered)){
  message(l1_file_list_filtered %>% slice(i))
  drive_download_(l1_file_list_filtered %>% slice(i))
}
toc()
```

```{r Set constant}

## Setting this as a constant so it will always match between sapflow and voltage
days_before = 14
days_after = 14

```


```{r Read in L1 data}

## To do: pull in voltage and rain as well then pivot_wider()
read_sapflow <- function(name){
  
  plot_from_filename = stringr::str_extract(name, "(?<=_)[^_]+(?=_)")
  
  read_csv(paste0(raw_data_path, name)) %>% 
  clean_names() %>% 
    mutate() %>% 
  filter(grepl("sapflow", research_name)) %>% 
    mutate(datetime_est = force_tz(timestamp, tzone = common_tz), 
           plot = plot_from_filename) %>% 
  dplyr::select(datetime_est, plot, location, instrument_id, sensor_id, value, contains("f_")) %>% 
  rename("sapflow_mv" = value)
}

##Bind data together and filter out the data we definitely won't need.
sapflow_raw <- l1_file_list_filtered$name %>%
  map(read_sapflow) %>%
  bind_rows() %>% 
  mutate(plot = case_when(plot == "C" ~ "Control",
                          plot == "S" ~ "Estuarine",
                          plot == "F" ~ "Freshwater"))


sapflow_trimmed <- sapflow_raw %>%
  filter(datetime_est > pre_event_start - days(days_before) &
           datetime_est < post_event_end + days(days_after))
          #datetime_est < post_event_end + days(1))
```

### Raw data

Let's first take a look at all the raw data.

```{r}
## Plotly plot to look at individual sensors
p <- ggplot(sapflow_trimmed, aes(datetime_est, sapflow_mv, color = sensor_id)) + 
  geom_line() + 
  geom_vline(xintercept = dump_start1, linetype = "dashed") + 
  geom_vline(xintercept = dump_start2, linetype = "dashed") + 
  facet_wrap(~plot, ncol = 1)

 ggplotly(p)
```

### QC

#### QC Step 1: Remove deep sensors

We will scrub the sensors with a "D" suffix which indicates they are deep sensors. Since these are primarily used for calculating areal rates which we aren't doing, we'll keep things apples to apples and remove them.

```{r}
sapflow_qc1 <- sapflow_trimmed %>% 
  filter(!grepl("D", sensor_id))

ggplot(sapflow_qc1, aes(datetime_est, sapflow_mv, color = sensor_id)) + 
  geom_line() + 
  geom_vline(xintercept = dump_start1, linetype = "dashed") + 
  geom_vline(xintercept = dump_start2, linetype = "dashed") + 
  facet_wrap(~plot, ncol = 1)
```

#### QC Step 2: examine voltages

Based on sapflow voltages, Control and Estuarine plots seem good to go, but there is a power issue in Freshwater for all loggers prior to 6/4 that seems to get fixed right before the event. Let's use the first datetime of good voltages in Freshwater as the start-date for our sapflow, which works out well since the redox sensors were installed after this date. The time when voltages resets is 2023-06-04 12:00:00. There's also some sort of step change in the Estuarine plot, which fortuitously happens around midnight on 6/13. Since we really only care about running sapflow out to 6/13 to overlap with veg measurements, let's cut that too:

```{r}

read_voltage <- function(name){
  
  plot_from_filename = stringr::str_extract(name, "(?<=_)[^_]+(?=_)")
  
  read_csv(paste0(raw_data_path, name)) %>% 
  clean_names() %>% 
  filter(research_name == "battery_voltage" & 
           instrument == "Sapflow") %>% 
  mutate(datetime_est = force_tz(timestamp, tzone = common_tz), 
            plot = plot_from_filename) %>% 
  dplyr::select(datetime_est, plot, location, instrument_id, value, contains("f_")) %>% 
    rename("voltage" = value)
} 

voltage_raw <- l1_file_list_filtered$name %>%
  map(read_voltage) %>%
  bind_rows() %>%
  mutate(plot = case_when(plot == "C" ~ "Control",
                          plot == "S" ~ "Estuarine",
                          plot == "F" ~ "Freshwater"))

voltage_trimmed <- voltage_raw %>%
  filter(datetime_est > pre_event_start - days(days_before) &
           datetime_est < post_event_end + days(days_after))
```

```{r}

## Pre-event voltage anomalies
voltage_trim_start1 = as.POSIXct("2023-05-29 00:00:00", tz = common_tz)
voltage_trim_end1 = as.POSIXct("2023-06-05 00:00:00", tz = common_tz)

## Post-event voltage anomalies
voltage_trim_start2 = as.POSIXct("2023-06-13 00:00:00", tz = common_tz)
voltage_trim_end2 = as.POSIXct("2023-06-16 00:00:00", tz = common_tz)

ggplot(voltage_trimmed, aes(datetime_est, voltage, 
                            color = as.factor(instrument_id))) + 
  geom_line() + 
  geom_vline(xintercept = dump_start1, linetype = "dashed", color = "gray") + 
  geom_vline(xintercept = dump_start2, linetype = "dashed", color = "gray") + 
  geom_vline(xintercept = voltage_trim_start1, linetype = "dashed", color = "black") + 
    geom_vline(xintercept = voltage_trim_end1, linetype = "dashed", color = "black") + 
    geom_vline(xintercept = voltage_trim_start2, linetype = "dashed", color = "black") + 
    geom_vline(xintercept = voltage_trim_end2, linetype = "dashed", color = "black") + 
  facet_wrap(~plot, ncol = 1)
```

```{r}

sapflow_qc2_initial <- sapflow_qc1 %>% 
  filter(datetime_est <= voltage_trim_start1 | 
           datetime_est >= voltage_trim_end1) %>% 
    filter(!(datetime_est > voltage_trim_start2 & 
               datetime_est < voltage_trim_end2 & 
               plot == "Estuarine"))

ggplot(sapflow_qc2_initial, aes(datetime_est, sapflow_mv, color = sensor_id)) + 
  geom_line() + 
  geom_vline(xintercept = dump_start1, linetype = "dashed") + 
  geom_vline(xintercept = dump_start2, linetype = "dashed") + 
  facet_wrap(~plot, ncol = 1)
```

We are getting closer, but there are some days tht re visually apparent anamolies that we should scrub. These include June 12, and then anything after ~ June 21

```{r}

## Pre-event voltage anomalies
voltage_trim_start3 = as.POSIXct("2023-06-12 00:00:00", tz = common_tz)
voltage_trim_end3 = as.POSIXct("2023-06-13 00:00:00", tz = common_tz)

## Post-event voltage anomalies
voltage_trim_start4 = as.POSIXct("2023-06-21 00:00:00", tz = common_tz)

ggplot(sapflow_qc2_initial, aes(datetime_est, sapflow_mv, color = sensor_id)) + 
  geom_line() + 
  geom_vline(xintercept = dump_start1, linetype = "dashed") + 
  geom_vline(xintercept = dump_start2, linetype = "dashed") + 
    geom_vline(xintercept = voltage_trim_start3, linetype = "dashed", color = "black") + 
    geom_vline(xintercept = voltage_trim_end3, linetype = "dashed", color = "black") + 
    geom_vline(xintercept = voltage_trim_start4, linetype = "dashed", color = "black") +
  facet_wrap(~plot, ncol = 1)

```
After removing those issues as well, this is our cleaned dataset after Step 2

```{r}
sapflow_qc2_final <- sapflow_qc2_initial %>% 
  filter(datetime_est <= voltage_trim_start3 | 
           datetime_est >= voltage_trim_end3) %>% 
    filter(datetime_est <= voltage_trim_start4)

ggplot(sapflow_qc2_final, aes(datetime_est, sapflow_mv, color = sensor_id)) + 
  geom_line() + 
  geom_vline(xintercept = dump_start1, linetype = "dashed") + 
  geom_vline(xintercept = dump_start2, linetype = "dashed") + 
  facet_wrap(~plot, ncol = 1)

```


#### QC Step 3: visual examination {.tabset}

These data are starting to look good, so let's look at individual sensors and see if there are any potential issues with jumps or trends or any other non-normalities we should pay attention to. Based on visual identification, the following sensors are sus for the following reasons:

 - F10: non-linear behavior
 - F20: high (values above 0.7)
 - C10: high (values above 0.8)
 - S2: linear trend
 - S8: linear trend

```{r results='asis', eval = FALSE}

plot_plots <- function(selected_plot){
  p <- ggplot(sapflow_qc2_final %>% filter(plot == selected_plot), 
              aes(datetime_est, sapflow_mv, color = sensor_id)) + 
    geom_line() + 
    geom_smooth(se = F) + 
    facet_wrap(~sensor_id)
  
  ggplotly(p)
}

selected_plot = unique(sapflow_qc2_final$plot)

for (i in 1:length(selected_plot)){
  cat(paste("#####", selected_plot[[i]]))
  cat("\n")
  print(plot_plots(selected_plot[[i]]))
  cat("\n\n")
}

```

####


```{r}

sensors_to_cull = c("F8", #trending down
                    "F10", #trending down / non-linear
                    "F20", #substantially higher than all other sensors in plot
                    "C10", #substantially higher than all other sensors in plot
                    "S2", #trending up
                    "S8", #trending up
                    "S10", #flatlined during pre
                    "S12", #flatlined during pre
                    "S14") #flatlined during pre

sapflow_qc3 <- sapflow_qc2_final %>% 
  filter(!(sensor_id %in% sensors_to_cull))

ggplot(sapflow_qc3, aes(datetime_est, sapflow_mv, color = sensor_id)) + 
  geom_line() + 
  geom_vline(xintercept = dump_start1, linetype = "dashed") + 
  geom_vline(xintercept = dump_start2, linetype = "dashed") + 
  facet_wrap(~plot, ncol = 1)


## We will save this dataset as "unbinned" 
write_csv(sapflow_qc3, "../data/240717_sapflow_final_unbinned.csv")
```

Final data are exported as *240507_sapflow_final_unbinned.csv* in the *data* folder


