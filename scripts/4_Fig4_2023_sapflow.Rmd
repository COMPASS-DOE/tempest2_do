---
title: "Untitled"
author: "PR"
date: "2025-04-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, 
                      warning = F, 
                      message = F)
```

### Purpose

This script ingests sapflow processed for 2023, normalizes the growing season to pre-flood values, then calculates slopes to see if they are significantly different from 0 and from each other. We're going to visualize each step along the way and explain all decisions (hopefully)


```{r}
source("../scripts/0_0_setup.R")
p_load(trend)
anyas_colors = c("springgreen2", "cyan2", "violetred2")
```


```{r}
df_raw <- read_csv("../data/250310_2023_sapflow.csv")

ggplot(df_raw, aes(doy, color = plot)) + 
  geom_point(aes(y = f_avg), alpha = 0.4) + 
  geom_line(aes(y = f_roll)) + 
  facet_wrap(~species, ncol = 1)
```

### Decision 1 - remove non-growing season

We are only interested in the growing season, since the non-growing season is basically just noise. We are interested in seeing how species green up and scenesce since that might show us differences between plots / species. Let's trim our dataset, mark our flood event, and add the color scheme, which gets us 90% of the way to Panel A: 

```{r}
## You'll need this for when your flooding occurred
flood_doy <- lubridate::yday(dump_start1)

df_trim <- df_raw %>% 
  filter(doy > 100 & doy < 300)

p1 <- ggplot(df_trim, aes(x = doy, color = plot)) + 
  geom_point(aes(y = f_avg), alpha = 0.4) + 
  geom_line(aes(y = f_roll)) + 
  geom_vline(xintercept = flood_doy, linetype = "dashed") + 
  facet_wrap(~species, ncol = 1) + 
  scale_color_manual(values = anyas_colors) + 
  labs(x = "Day of Year", y = "Sap flux (cm3/s)", color = "") + 
  theme(legend.position = c(0.8, 0.6), 
        legend.background = element_blank(), 
        legend.key = element_rect(fill = NA, color = NA)) 

p1
```

### Decision 2: Normalize data following McDowell et al. (2006)

Per Nate's suggestion, we will do a 2-part normalization to make sure we are assessing response to disturbance in a consistent framework. This is a two-step process: 

  1. Normalize each time-series to the pre-flood mean
  2. Normalize each time-point to Control

### Normalize each time-series to the pre-flood mean, then to Control

We are going to use the 30 days prior to the first day of flooding to calculate our pre-flood mean. We selected 30 days since 1) it's approximately a month, and 2) it doesn't show large changes in the plot above. We will scrub all data prior to 30 days before the flooding event since it's already present in the figure above, and it's not useful.

```{r}

## Things are a little funky here. It seemed like I could do this really tidily but then things kept looking weird so I'm opting for the aggressively transparent, ugly version of the code.

df_trim2 <- df_trim %>% 
  group_by(plot, species) %>% 
  mutate(pre_mean = mean(f_avg[doy < flood_doy])) %>% 
  mutate(f_avg_n = f_avg - pre_mean)

calculate_deltas <- function(selected_spp){
  
  ## Set constants
  roll_length = 10
  
  df_trim2 %>% 
    filter(species == selected_spp) %>% 
    dplyr::select(plot, doy, f_avg_n) %>% 
    pivot_wider(names_from = "plot", values_from = "f_avg_n") %>% 
    mutate(delta_sw = Saltwater - Control, 
           delta_fw = Freshwater - Control) %>% 
    mutate(delta_sw_roll = zoo::rollmean(delta_sw, roll_length, fill = NA), 
           delta_fw_roll = zoo::rollmean(delta_fw, roll_length, fill = NA)) %>% 
    mutate(species = selected_spp)
}

deltas <- bind_rows(calculate_deltas("Tulip Poplar"), 
                    calculate_deltas("Beech"), 
                    calculate_deltas("Red Maple"))


p2 <- ggplot(deltas, aes(x = doy)) + 
  geom_point(aes(y = delta_fw), alpha = 0.4, color = anyas_colors[2]) + 
  geom_point(aes(y = delta_sw), alpha = 0.4, color = anyas_colors[3]) + 
  geom_line(aes(y = delta_fw_roll), color = anyas_colors[2]) + 
  geom_line(aes(y = delta_sw_roll), color = anyas_colors[3]) + 
  geom_smooth(data = deltas %>% filter(doy > flood_doy), 
              aes(y = delta_fw), method  = "lm", se = F, 
              alpha = 0.6, color = anyas_colors[2]) + 
  geom_smooth(data = deltas %>% filter(doy > flood_doy), 
              aes(y = delta_sw), method  = "lm", se = F,
              alpha = 0.6, color = anyas_colors[3]) + 
  geom_vline(xintercept = flood_doy, linetype = "dashed") + 
  facet_wrap(~species, ncol = 1) + 
  labs(x = "Day of Year", y = "Normalized sap flux", color = "") + 
  theme(legend.position = c(0.8, 0.6), 
        legend.background = element_blank(), 
        legend.key = element_rect(fill = NA, color = NA)) 

p2 

```

### Some stats

Let's use Sen-Thiel slopes to understand if slopes are different from each other, and different from zero: 

#### Stats for raw values
```{r}
bind_rows(deltas %>% 
            ungroup() %>% 
            group_by(species) %>% 
            summarize(slope = sens.slope(delta_fw)$estimates[1], 
                      p = sens.slope(delta_fw)$p.value) %>% 
            mutate(plot = "Freshwater"), 
          deltas %>% 
            ungroup() %>% 
            group_by(species) %>% 
            summarize(slope = sens.slope(delta_sw)$estimates[1], 
                      p = sens.slope(delta_sw)$p.value) %>% 
            mutate(plot = "Saltwater"))
```

#### The same stats but for rolling means
```{r}

deltas_no_na <- deltas %>% 
  drop_na() 

bind_rows(deltas_no_na %>% 
            ungroup() %>% 
            group_by(species) %>% 
            summarize(slope = sens.slope(delta_fw_roll)$estimates[1], 
                      p = sens.slope(delta_fw_roll)$p.value) %>% 
            mutate(plot = "Freshwater"), 
          deltas_no_na %>% 
            ungroup() %>% 
            group_by(species) %>% 
            summarize(slope = sens.slope(delta_sw_roll)$estimates[1], 
                      p = sens.slope(delta_sw_roll)$p.value) %>% 
            mutate(plot = "Saltwater"))
```


### Put them together

```{r}
plot_grid(p1, p2, nrow = 1, 
          rel_widths = c(1, 0.7))
ggsave("../figures/4_sapflow.png", width = 10, height = 7)
ggsave("../figures/4_sapflow.pdf", width = 10, height = 7)

```




